# 实施计划

根据对现有代码的分析，`BackpackManager` 已经是持久化单例，无需修改即可跨场景使用。为了实现“剧情需要时出示证物”的功能，我们需要修改背包 UI 以支持“选择模式”，并在剧本管理器中添加相应的指令。

## 1. 确认单例状态
`BackpackManager.cs` 中已有 `DontDestroyOnLoad` 代码，因此只要从 Menu 或其他场景初始化过一次，进入 Debate 场景后它依然存在，数据会自动保留。

## 2. 修改 BackpackUI (支持出示模式)
目前背包只能查看详情。我们需要增加一个“出示”按钮和相应的逻辑。

**修改内容：**
- **新增变量**：`onEvidenceSelected` 回调，用于通知外部（剧本系统）玩家选了哪个证物。
- **新增 UI 引用**：`presentButton` (出示按钮)，通常放在详情面板下方。
- **新增方法**：`OpenForSelection(System.Action<string> callback)`，进入选择模式。
- **逻辑调整**：
    - 在 `OpenForSelection` 中显示“出示”按钮。
    - 在普通打开模式下隐藏“出示”按钮。
    - 点击“出示”按钮时，调用回调并关闭背包。

## 3. 修改 TreatmentManager (新增指令)
在 `HandleCommand` 中新增 `RequireEvidence` 指令，用于暂停剧情并等待玩家出示。

**新增指令逻辑 (`RequireEvidence`)：**
- **参数**：`[0] 正确的证物ID`, `[1] 成功跳转ID`, `[2] 失败跳转ID`
- **流程**：
    1. 暂停剧本执行 (`isWaitingForInput = false`)。
    2. 调用 `BackpackUI.Instance.OpenForSelection`。
    3. 在回调中比对玩家选择的 ID 是否等于 正确 ID。
    4. 根据结果跳转到不同剧情分支 (`JumpToLine`)。

## 4. JSON 剧本编写示例
我将为您提供如何在 JSON 中使用这两个功能的示例。

### 记录证物 (已有功能)
使用 `AddEvidence` 指令：
```json
{
    "type": "command",
    "command": "AddEvidence",
    "parameters": [ "knife_01", "带血的刀", "案发现场发现的刀..." ]
}
```

### 要求出示证物 (新功能)
使用 `RequireEvidence` 指令：
```json
{
    "type": "command",
    "command": "RequireEvidence",
    "parameters": [ "knife_01", "line_success_branch", "line_fail_branch" ]
}
```

---
**待确认事项：**
- 您需要在 Unity 编辑器中为 `BackpackUI` 的详情面板 (`DetailPanel`) 添加一个 Button (命名为 PresentButton)，稍后我修改代码后，您需要将其拖拽到脚本的新增槽位中。
- 确认是否执行上述代码修改？
